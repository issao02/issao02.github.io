<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empresas B3 | Lista Completa com Filtros</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0c0e14;
      --surface: #151922;
      --surface-hover: #1c2029;
      --accent: #00c853;
      --accent-dim: #00a843;
      --negative: #ff5252;
      --text: #e8eaed;
      --text-muted: #8b9199;
      --border: #2a2f3a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--surface) 0%, #0f1319 100%);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem 2rem;
    }

    .header-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--bg);
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .logo span {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.95rem;
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .header-info strong { color: var(--accent); font-weight: 600; }

    .btn-atualizar {
      padding: 0.6rem 1.25rem;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }

    .btn-atualizar:hover { background: var(--accent-dim); }
    .btn-atualizar:disabled { opacity: 0.6; cursor: not-allowed; }

    .filtros {
      background: var(--surface);
      padding: 1.25rem 2rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .filtros-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }

    .filtro-grupo {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .filtro-grupo label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .filtro-grupo input,
    .filtro-grupo select {
      padding: 0.6rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      background: var(--bg);
      color: var(--text);
      min-width: 160px;
    }

    .filtro-grupo input:focus,
    .filtro-grupo select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem 2rem 2rem;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .contador {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .contador strong { color: var(--text); }

    .btn-indicadores {
      padding: 0.5rem 1rem;
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-indicadores:hover:not(:disabled) {
      background: var(--accent);
      color: var(--bg);
    }

    .btn-indicadores:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-colunas {
      padding: 0.5rem 1rem;
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .btn-colunas:hover { color: var(--accent); border-color: var(--accent); }
    .colunas-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 0.35rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      padding: 0.5rem;
      z-index: 100;
      min-width: 180px;
      max-height: 320px;
      overflow-y: auto;
    }
    .colunas-dropdown.ativo { display: block; }
    .colunas-dropdown label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .colunas-dropdown label:hover { background: var(--surface-hover); }
    .colunas-dropdown input[type="checkbox"] { cursor: pointer; }
    .colunas-dropdown label.colunas-todos { border-bottom: 1px solid var(--border); margin-bottom: 0.35rem; padding-bottom: 0.5rem; }

    .table-wrap {
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-scroll {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: var(--surface-hover);
      padding: 1rem 1.25rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-muted);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
    }

    th:hover { color: var(--accent); }

    th.draggable-col {
      cursor: grab;
      padding-right: 1.5rem;
      position: relative;
    }
    th.draggable-col::before {
      content: '‚ãÆ‚ãÆ';
      position: absolute;
      right: 0.5rem;
      font-size: 0.7rem;
      opacity: 0.5;
      letter-spacing: -0.2em;
    }
    th.draggable-col:active { cursor: grabbing; }
    th.dragging-col { opacity: 0.5; background: var(--accent); }
    th.drag-over { border-left: 2px solid var(--accent); }

    th.sorted-asc::after { content: ' ‚Üë'; color: var(--accent); }
    th.sorted-desc::after { content: ' ‚Üì'; color: var(--accent); }

    td {
      padding: 0.85rem 1.25rem;
      border-top: 1px solid var(--border);
      transition: background 0.15s;
    }

    tr:hover td { background: var(--surface-hover); }

    tr.ativo td { background: rgba(0, 200, 83, 0.08); }
    tr.ativo:hover td { background: rgba(0, 200, 83, 0.12); }

    .ticker {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
    }

    .ticker:hover { text-decoration: underline; }

    .nome-empresa {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .positivo { color: var(--accent); }
    .negativo { color: var(--negative); }
    .neutro { color: var(--text-muted); }

    .numero { font-family: 'JetBrains Mono', monospace; text-align: right; }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      background: rgba(0, 200, 83, 0.15);
      color: var(--accent);
    }
    .badge-bluechip { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
    .badge-smallcap { background: rgba(255, 152, 0, 0.2); color: #ff9800; }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .erro {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--negative);
      background: rgba(255, 82, 82, 0.1);
      border-radius: 12px;
      margin: 2rem 0;
    }

    .erro p { margin-bottom: 0.5rem; }
    .erro small { color: var(--text-muted); }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      overflow-y: auto;
    }

    .modal-overlay.ativo { display: flex; }

    .modal {
      background: var(--surface);
      border-radius: 16px;
      max-width: 560px;
      width: 100%;
      border: 1px solid var(--border);
      overflow: hidden;
      position: relative;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .modal-logo {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      object-fit: contain;
      background: var(--bg);
    }

    .modal-ticker {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .modal-nome {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .modal-fechar {
      margin-left: auto;
      width: 40px;
      height: 40px;
      border: none;
      background: var(--border);
      color: var(--text);
      border-radius: 10px;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .modal-fechar:hover { background: var(--negative); }

    .modal-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 85vh;
      overflow-y: auto;
    }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem 0.75rem; }
    .modal-chart-section {
      grid-column: 1 / -1;
      margin-top: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .modal-chart-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .modal-chart-filters button {
      padding: 0.4rem 0.75rem;
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-chart-filters button:hover { color: var(--accent); border-color: var(--accent); }
    .modal-chart-filters button.ativo { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .modal-chart-wrap {
      position: relative;
      height: 280px;
      width: 100%;
    }

    .modal-item {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .modal-item label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .modal-item span {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .modal-loading {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
    }

    .link-voltar {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      margin-top: 1rem;
      transition: color 0.2s;
    }

    .link-voltar:hover { color: var(--accent-dim); }

    @media (max-width: 768px) {
      .modal-body .modal-grid { grid-template-columns: 1fr; }
      th, td { padding: 0.75rem 1rem; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">B3</div>
        <div>
          <h1>Empresas B3</h1>
          <span>Lista completa com dados em tempo real</span>
        </div>
      </div>
      <div class="header-info">
        <span>√öltima atualiza√ß√£o: <strong id="lastUpdate">‚Äî</strong></span>
        <span>Total: <strong id="totalCount">0</strong> ativos</span>
        <span style="display:flex;align-items:center;gap:0.5rem;">
          <label for="brapiToken" style="font-size:0.8rem;">Token brapi:</label>
          <input type="password" id="brapiToken" placeholder="Token (brapi.dev)" style="width:140px;padding:0.35rem 0.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:0.8rem;" title="Token gratuito em brapi.dev ‚Äî necess√°rio para indicadores P/L, Div.Yield">
        </span>
      </div>
      <button type="button" class="btn-atualizar" id="btnAtualizar" title="Buscar dados atualizados da brapi.dev">
        <span>‚Üª</span> Atualizar dados
      </button>
    </div>
  </header>

  <div class="filtros">
    <div class="filtros-inner">
        <div class="filtro-grupo">
          <label for="filtroBusca">Buscar</label>
          <input type="text" id="filtroBusca" placeholder="Ticker ou nome da empresa...">
        </div>
        <div class="filtro-grupo">
          <label for="filtroSetor">Setor</label>
          <select id="filtroSetor">
            <option value="">Todos os setores</option>
          </select>
        </div>
        <div class="filtro-grupo">
          <label for="filtroTipo">Tipo</label>
          <select id="filtroTipo">
            <option value="">Todos</option>
            <option value="stock">A√ß√µes</option>
            <option value="fii">FIIs</option>
            <option value="etf">ETFs</option>
            <option value="bdr">BDRs</option>
            <option value="unit">Units</option>
          </select>
        </div>
        <div class="filtro-grupo">
          <label for="filtroCap">Cap</label>
          <select id="filtroCap">
            <option value="">Todos</option>
            <option value="bluechip">Blue Chip</option>
            <option value="smallcap">Small Cap</option>
          </select>
        </div>
        <div class="filtro-grupo">
          <label for="filtroPL">P/L m√°x.</label>
          <input type="number" id="filtroPL" placeholder="Ex: 15" min="0" step="0.1">
        </div>
        <div class="filtro-grupo">
          <label for="filtroDivYield">Div.Yield m√≠n. %</label>
          <input type="number" id="filtroDivYield" placeholder="Ex: 5" min="0" step="0.1">
        </div>
        <div class="filtro-grupo">
          <label for="filtroPVP">P/VP m√°x.</label>
          <input type="number" id="filtroPVP" placeholder="Ex: 2" min="0" step="0.1">
        </div>
        <div class="filtro-grupo">
          <label for="filtroROE">ROE m√≠n. %</label>
          <input type="number" id="filtroROE" placeholder="Ex: 15" min="-100" step="0.5">
        </div>
        <div class="filtro-grupo">
          <label for="filtroPayout">Payout m√°x. %</label>
          <input type="number" id="filtroPayout" placeholder="Ex: 60" min="0" step="1">
        </div>
    </div>
  </div>

  <main class="container">
    <div class="toolbar">
      <p class="contador">Exibindo <strong id="filteredCount">0</strong> de <strong id="totalDisplay">0</strong> ativos</p>
      <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
        <div style="position:relative;">
          <button type="button" class="btn-colunas" id="btnColunas" title="Mostrar ou ocultar colunas">
            Colunas
          </button>
          <div class="colunas-dropdown" id="colunasDropdown">
            <!-- preenchido via JS -->
          </div>
        </div>
        <button type="button" class="btn-indicadores" id="btnIndicadores" title="Busca P/L, LPA e Div. Yield para os ativos exibidos">
          üìä Carregar indicadores (P/L, LPA, Div.Yield)
        </button>
        <span id="indicadoresStatus" class="contador" style="font-size:0.85rem;"></span>
      </div>
    </div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table>
          <thead><tr id="tableHeaderRow"></tr></thead>
          <tbody id="tbody">
            <tr>
              <td colspan="14" class="loading">
                <div class="loading-spinner"></div>
                Carregando dados da B3...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <a href="../" class="link-voltar">‚Üê Voltar aos projetos</a>
  </main>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <img class="modal-logo" id="modalLogo" src="" alt="">
        <div>
          <div class="modal-ticker" id="modalTicker">‚Äî</div>
          <div class="modal-nome" id="modalNome">‚Äî</div>
        </div>
        <button type="button" class="modal-fechar" id="modalFechar">√ó</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="modal-loading">Carregando detalhes...</div>
      </div>
    </div>
  </div>

  <script>
    const BRAPI_LIST = 'https://brapi.dev/api/quote/list';
    const BRAPI_QUOTE = 'https://brapi.dev/api/quote/';
    const TOKEN_KEY = 'empresasb3_brapi_token';

    function getToken() {
      const el = document.getElementById('brapiToken');
      return (el?.value || localStorage.getItem(TOKEN_KEY) || 'demo').trim() || 'demo';
    }

    let dados = [];
    let dadosFiltrados = [];
    let sortCol = 'market_cap';
    let sortDir = 'desc';

    const tbody = document.getElementById('tbody');
    const btnAtualizar = document.getElementById('btnAtualizar');
    const filtroBusca = document.getElementById('filtroBusca');
    const filtroSetor = document.getElementById('filtroSetor');
    const filtroTipo = document.getElementById('filtroTipo');
    const filtroPL = document.getElementById('filtroPL');
    const filtroDivYield = document.getElementById('filtroDivYield');
    const filtroPVP = document.getElementById('filtroPVP');
    const filtroROE = document.getElementById('filtroROE');
    const filtroPayout = document.getElementById('filtroPayout');
    const filtroCap = document.getElementById('filtroCap');
    const lastUpdate = document.getElementById('lastUpdate');
    const totalCount = document.getElementById('totalCount');
    const filteredCount = document.getElementById('filteredCount');
    const totalDisplay = document.getElementById('totalDisplay');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalBody = document.getElementById('modalBody');
    const modalLogo = document.getElementById('modalLogo');
    const modalTicker = document.getElementById('modalTicker');
    const modalNome = document.getElementById('modalNome');
    const modalFechar = document.getElementById('modalFechar');

    function fmtMoeda(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      if (v >= 1e12) return 'R$ ' + (v / 1e12).toFixed(2) + ' tri';
      if (v >= 1e9) return 'R$ ' + (v / 1e9).toFixed(2) + ' bi';
      if (v >= 1e6) return 'R$ ' + (v / 1e6).toFixed(2) + ' mi';
      if (v >= 1e3) return 'R$ ' + (v / 1e3).toFixed(2) + ' mil';
      return 'R$ ' + Number(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtNum(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      return Number(v).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function fmtPct(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      const n = Number(v);
      const s = n >= 0 ? '+' : '';
      return s + n.toFixed(2) + '%';
    }

    function fmtPreco(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      return 'R$ ' + Number(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtPL(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      const n = Number(v);
      return n > 0 ? n.toFixed(2) : '‚Äî';
    }

    function fmtLPA(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      return 'R$ ' + Number(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtDivYield(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      return Number(v).toFixed(2) + '%';
    }

    function fmtPayout(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      return Number(v).toFixed(1) + '%';
    }

    function fmtRoe(v) {
      if (v == null || v === '' || isNaN(v)) return '‚Äî';
      const n = Number(v);
      const pct = Math.abs(n) <= 1 ? n * 100 : n;
      return pct.toFixed(2) + '%';
    }

    const tipoDesc = { stock: 'A√ß√£o', fii: 'FII', etf: 'ETF', bdr: 'BDR', unit: 'Unit' };
    function tipoDescritivo(t) {
      return (t && tipoDesc[t.toLowerCase()]) || t || '‚Äî';
    }

    const setorDesc = {
      'Energy Minerals': 'Petr√≥leo e G√°s',
      'Non-Energy Minerals': 'Minera√ß√£o',
      'Finance': 'Financeiro',
      'Retail Trade': 'Varejo',
      'Transportation': 'Transporte',
      'Utilities': 'Utilidades P√∫blicas',
      'Technology': 'Tecnologia',
      'Health Services': 'Sa√∫de',
      'Consumer Non-Durables': 'Bens de Consumo',
      'Industrial Services': 'Servi√ßos Industriais',
      'Consumer Durables': 'Bens Dur√°veis',
      'Communication Services': 'Comunica√ß√µes',
      'Consumer Discretionary': 'Consumo Discricion√°rio',
      'Consumer Staples': 'Bens de Consumo Essenciais',
      'Energy': 'Energia',
      'Financials': 'Financeiro',
      'Health Care': 'Sa√∫de',
      'Industrials': 'Industrial',
      'Information Technology': 'Tecnologia da Informa√ß√£o',
      'Materials': 'Materiais',
      'Real Estate': 'Imobili√°rio',
      'Process Industries': 'Ind√∫stria de Processos',
      'Producer Manufacturing': 'Manufatura',
      'Commercial Services': 'Servi√ßos Comerciais',
      'Electronic Technology': 'Tecnologia Eletr√¥nica',
      'Distribution Services': 'Distribui√ß√£o',
      'Miscellaneous': 'Diversos',
      'Outros': 'Outros',
      'Durable Goods': 'Bens Dur√°veis',
      'Nondurable Goods': 'Bens N√£o Dur√°veis',
      'Government': 'Governo',
      'Agricultural': 'Agropecu√°rio'
    };
    function setorDescritivo(s) {
      if (!s) return '‚Äî';
      return setorDesc[s] || s;
    }

    const BLUE_CHIP_MIN = 2e10;
    const SMALL_CAP_MAX = 2e9;
    function classificacaoCap(d) {
      const mc = Number(d.market_cap);
      if (!mc || isNaN(mc)) return null;
      if (mc >= BLUE_CHIP_MIN) return 'bluechip';
      if (mc < SMALL_CAP_MAX) return 'smallcap';
      return null;
    }
    const COLUMN_KEYS = ['stock','name','close','change','volume','market_cap','priceEarnings','earningsPerShare','dividendYield','priceToBook','returnOnEquity','payout','sector','cap','type'];
    const COLUMNS = {
      stock: { label: 'Ticker', title: 'C√≥digo de negocia√ß√£o do ativo na B3 (ex: PETR4, VALE3)', sort: 'stock', cell: d => `<span class="ticker">${d.stock || '‚Äî'}</span>`, cls: '' },
      name: { label: 'Empresa', title: 'Nome da empresa ou fundo', sort: 'name', cell: d => (d.name || '‚Äî').replace(/</g, '&lt;').replace(/"/g, '&quot;'), cls: 'nome-empresa', tdTitle: d => d.name || '' },
      close: { label: 'Pre√ßo', title: 'Pre√ßo atual de fechamento da √∫ltima cota√ß√£o', sort: 'close', cell: d => fmtPreco(d.close), cls: 'numero' },
      change: { label: 'Varia√ß√£o %', title: 'Varia√ß√£o percentual do pre√ßo em rela√ß√£o ao fechamento anterior', sort: 'change', cell: d => `<span class="numero ${classeVariacao(d.change != null ? Number(d.change) : null)}">${fmtPct(d.change)}</span>`, cls: 'numero' },
      volume: { label: 'Volume', title: 'Quantidade de a√ß√µes/cotas negociadas no per√≠odo', sort: 'volume', cell: d => fmtNum(d.volume), cls: 'numero' },
      market_cap: { label: 'Valor Mercado', title: 'Valor de mercado (pre√ßo √ó quantidade de a√ß√µes em circula√ß√£o)', sort: 'market_cap', cell: d => fmtMoeda(d.market_cap), cls: 'numero' },
      priceEarnings: { label: 'P/L', title: 'Pre√ßo/Lucro: pre√ßo da a√ß√£o dividido pelo lucro por a√ß√£o. Clique em Carregar indicadores.', sort: 'priceEarnings', cell: d => fmtPL(d.priceEarnings), cls: 'numero' },
      earningsPerShare: { label: 'LPA', title: 'Lucro por A√ß√£o: lucro l√≠quido dividido pelo n√∫mero de a√ß√µes', sort: 'earningsPerShare', cell: d => fmtLPA(d.earningsPerShare), cls: 'numero' },
      dividendYield: { label: 'Div.Yield', title: 'Dividend Yield: dividendos dos √∫ltimos 12 meses em % do pre√ßo', sort: 'dividendYield', cell: d => fmtDivYield(d.dividendYield), cls: 'numero' },
      priceToBook: { label: 'P/VP', title: 'Pre√ßo/Valor Patrimonial: pre√ßo √∑ valor patrimonial por a√ß√£o', sort: 'priceToBook', cell: d => d.priceToBook != null ? Number(d.priceToBook).toFixed(2) : '‚Äî', cls: 'numero' },
      returnOnEquity: { label: 'ROE', title: 'Retorno sobre Patrim√¥nio L√≠quido em %', sort: 'returnOnEquity', cell: d => fmtRoe(d.returnOnEquity), cls: 'numero' },
      payout: { label: 'Payout', title: 'Payout: % do lucro distribu√≠do como dividendo', sort: 'payout', cell: d => fmtPayout(d.payout), cls: 'numero' },
      sector: { label: 'Setor', title: 'Setor de atua√ß√£o da empresa (ex: Financeiro, Petr√≥leo)', sort: 'sector', cell: d => setorDescritivo(d.sector), cls: '' },
      cap: { label: 'Cap', title: 'Blue Chip: valor mercado ‚â• R$ 20 bi. Small Cap: valor mercado < R$ 2 bi.', sort: 'cap', cell: d => { const c = classificacaoCap(d); if (c === 'bluechip') return '<span class="badge badge-bluechip">Blue Chip</span>'; if (c === 'smallcap') return '<span class="badge badge-smallcap">Small Cap</span>'; return '‚Äî'; }, cls: '' },
      type: { label: 'Tipo', title: 'Tipo do ativo: A√ß√£o, FII, ETF, BDR ou Unit', sort: 'type', cell: d => `<span class="badge">${tipoDescritivo(d.type)}</span>`, cls: '' }
    };
    const COL_ORDER_KEY = 'empresasb3_column_order';
    const COL_VIS_KEY = 'empresasb3_column_visibility';
    function getColumnOrder() {
      try {
        const s = localStorage.getItem(COL_ORDER_KEY);
        if (s) {
          const arr = JSON.parse(s);
          if (Array.isArray(arr) && arr.length === COLUMN_KEYS.length && arr.every(k => COLUMN_KEYS.includes(k))) return arr;
        }
      } catch (_) {}
      return [...COLUMN_KEYS];
    }
    function setColumnOrder(order) {
      localStorage.setItem(COL_ORDER_KEY, JSON.stringify(order));
    }
    function getColumnVisibility() {
      try {
        const s = localStorage.getItem(COL_VIS_KEY);
        if (s) {
          const o = JSON.parse(s);
          if (o && typeof o === 'object') {
            const out = {};
            COLUMN_KEYS.forEach(k => { out[k] = o[k] !== false; });
            return out;
          }
        }
      } catch (_) {}
      return Object.fromEntries(COLUMN_KEYS.map(k => [k, true]));
    }
    function setColumnVisibility(vis) {
      localStorage.setItem(COL_VIS_KEY, JSON.stringify(vis));
    }
    let columnOrder = getColumnOrder();
    let columnVisibility = getColumnVisibility();
    function getVisibleColumnOrder() {
      return columnOrder.filter(k => columnVisibility[k] !== false);
    }
    let visibleColumnOrder = getVisibleColumnOrder();
    const headerRow = document.getElementById('tableHeaderRow');

    function buildTableHeader() {
      visibleColumnOrder = getVisibleColumnOrder();
      headerRow.innerHTML = '';
      if (visibleColumnOrder.length === 0) {
        const th = document.createElement('th');
        th.colSpan = columnOrder.length;
        th.style.textAlign = 'center';
        th.style.color = 'var(--text-muted)';
        th.textContent = 'Nenhuma coluna selecionada ‚Äî marque "Todos" ou escolha colunas';
        headerRow.appendChild(th);
        return;
      }
      visibleColumnOrder.forEach((key, idx) => {
        const col = COLUMNS[key];
        if (!col) return;
        const th = document.createElement('th');
        th.className = 'draggable-col' + (col.cls ? ' ' + col.cls : '');
        th.dataset.sort = col.sort;
        th.dataset.colKey = key;
        th.title = col.title;
        th.textContent = col.label;
        th.draggable = true;
        th.addEventListener('dragstart', onDragStart);
        th.addEventListener('dragover', onDragOver);
        th.addEventListener('drop', onDrop);
        th.addEventListener('dragend', onDragEnd);
        th.addEventListener('dragleave', onDragLeave);
        headerRow.appendChild(th);
      });
      // sort click via delegation
      headerRow.querySelectorAll('th[data-sort]').forEach(th => {
        th.onclick = () => {
          const col = th.dataset.sort;
          if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortCol = col; sortDir = 'asc'; }
          ordenar();
          renderizar();
        };
      });
    }

    let draggedKey = null;
    function onDragStart(e) {
      draggedKey = e.target.dataset.colKey;
      e.target.classList.add('dragging-col');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedKey);
    }
    function onDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const t = e.currentTarget;
      if (t !== e.target.closest('th')) return;
      headerRow.querySelectorAll('th').forEach(h => h.classList.remove('drag-over'));
      t.classList.add('drag-over');
    }
    function onDragLeave(e) {
      if (!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over');
    }
    function onDrop(e) {
      e.preventDefault();
      const targetKey = e.currentTarget.dataset.colKey;
      e.currentTarget.classList.remove('drag-over');
      if (!draggedKey || draggedKey === targetKey) return;
      const newOrder = columnOrder.filter(k => k !== draggedKey);
      const idx = newOrder.indexOf(targetKey);
      newOrder.splice(idx, 0, draggedKey);
      columnOrder = newOrder;
      setColumnOrder(columnOrder);
      buildTableHeader();
      renderizar();
    }
    function onDragEnd(e) {
      e.target.classList.remove('dragging-col');
      headerRow.querySelectorAll('th').forEach(h => h.classList.remove('drag-over'));
      draggedKey = null;
    }

    function buildColunasDropdown() {
      const dd = document.getElementById('colunasDropdown');
      if (!dd) return;
      const visible = getVisibleColumnOrder();
      const todosChecked = visible.length === columnOrder.length;
      dd.innerHTML = '<label class="colunas-todos"><input type="checkbox" id="colunasTodos" ' + (todosChecked ? 'checked' : '') + '> <strong>Todos</strong></label>' +
        columnOrder.map(key => {
          const col = COLUMNS[key];
          if (!col) return '';
          const checked = columnVisibility[key] !== false;
          return '<label><input type="checkbox" data-col="' + key + '" ' + (checked ? 'checked' : '') + '> ' + (col.label || key) + '</label>';
        }).join('');
      const cbTodos = dd.querySelector('#colunasTodos');
      if (cbTodos) {
        cbTodos.addEventListener('change', () => {
          if (cbTodos.checked) {
            columnOrder.forEach(k => { columnVisibility[k] = true; });
          } else {
            columnOrder.forEach(k => { columnVisibility[k] = false; });
          }
          setColumnVisibility(columnVisibility);
          buildTableHeader();
          renderizar();
          buildColunasDropdown();
        });
      }
      dd.querySelectorAll('input[type="checkbox"][data-col]').forEach(cb => {
        cb.addEventListener('change', () => {
          const key = cb.dataset.col;
          columnVisibility[key] = cb.checked;
          setColumnVisibility(columnVisibility);
          const v = getVisibleColumnOrder();
          if (cbTodos) cbTodos.checked = v.length === columnOrder.length;
          buildTableHeader();
          renderizar();
          buildColunasDropdown();
        });
      });
    }

    function classeVariacao(v) {
      if (v == null || v === '' || isNaN(v)) return 'neutro';
      return Number(v) > 0 ? 'positivo' : Number(v) < 0 ? 'negativo' : 'neutro';
    }

    const colCount = () => getVisibleColumnOrder().length;

    async function carregarDados() {
      tbody.innerHTML = '<tr><td colspan="' + Math.max(colCount(), 1) + '" class="loading"><div class="loading-spinner"></div>Carregando dados da B3...</td></tr>';
      btnAtualizar.disabled = true;

      try {
        const url = `${BRAPI_LIST}?token=${getToken()}`;
        const res = await fetch(url);

        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

        const json = await res.json();
        const stocks = json.stocks || [];

        dados = stocks;
        lastUpdate.textContent = new Date().toLocaleString('pt-BR');
        totalCount.textContent = dados.length;

        popularSetores();
        aplicarFiltros();
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="' + Math.max(colCount(), 1) + '"><div class="erro"><p>Erro ao carregar dados</p><small>' + (e.message || 'Verifique sua conex√£o e tente novamente.') + '</small><br><small>Dados via brapi.dev ‚Äî use token pr√≥prio para mais requisi√ß√µes.</small></div></td></tr>';
      } finally {
        btnAtualizar.disabled = false;
      }
    }

    function popularSetores() {
      const setores = [...new Set(dados.map(d => d.sector || 'Outros').filter(Boolean))].sort();
      filtroSetor.innerHTML = '<option value="">Todos os setores</option>';
      setores.forEach(s => {
        filtroSetor.innerHTML += `<option value="${(s + '').replace(/"/g, '&quot;')}">${setorDescritivo(s)}</option>`;
      });
    }

    function aplicarFiltros() {
      let base = [...dados];
      const busca = (filtroBusca.value || '').trim().toLowerCase();
      const setor = (filtroSetor.value || '').trim();
      const tipo = (filtroTipo.value || '').trim();
      const plMax = parseFloat(filtroPL?.value) || 0;
      const divMin = parseFloat(filtroDivYield?.value) || 0;
      const pvpMax = parseFloat(filtroPVP?.value) || 0;
      const roeMin = parseFloat(filtroROE?.value) || 0;
      const payoutMax = parseFloat(filtroPayout?.value) || 0;
      const capFiltro = (filtroCap?.value || '').trim();

      if (busca) {
        base = base.filter(d =>
          (d.stock || '').toLowerCase().includes(busca) ||
          (d.name || '').toLowerCase().includes(busca)
        );
      }
      if (setor) base = base.filter(d => (d.sector || '') === setor);
      if (tipo) base = base.filter(d => (d.type || '') === tipo);
      if (plMax > 0) base = base.filter(d => {
        const pl = Number(d.priceEarnings);
        return !isNaN(pl) && pl > 0 && pl <= plMax;
      });
      if (divMin > 0) base = base.filter(d => {
        const dy = Number(d.dividendYield);
        return !isNaN(dy) && dy >= divMin;
      });
      if (pvpMax > 0) base = base.filter(d => {
        const pvp = Number(d.priceToBook);
        return !isNaN(pvp) && pvp > 0 && pvp <= pvpMax;
      });
      if (roeMin !== 0) base = base.filter(d => {
        const roe = Number(d.returnOnEquity);
        if (isNaN(roe)) return false;
        const pct = Math.abs(roe) <= 1 ? roe * 100 : roe;
        return pct >= roeMin;
      });
      if (payoutMax > 0) base = base.filter(d => {
        const py = Number(d.payout);
        return !isNaN(py) && py >= 0 && py <= payoutMax;
      });
      if (capFiltro === 'bluechip') base = base.filter(d => classificacaoCap(d) === 'bluechip');
      if (capFiltro === 'smallcap') base = base.filter(d => classificacaoCap(d) === 'smallcap');

      dadosFiltrados = base;
      ordenar();
      renderizar();
    }

    function ordenar() {
      const col = sortCol;
      const dir = sortDir === 'asc' ? 1 : -1;

      dadosFiltrados.sort((a, b) => {
        let va = col === 'cap' ? (classificacaoCap(a) || 'mid') : a[col];
        let vb = col === 'cap' ? (classificacaoCap(b) || 'mid') : b[col];
        if (typeof va === 'string') va = (va || '').toLowerCase();
        if (typeof vb === 'string') vb = (vb || '').toLowerCase();
        if (va == null) va = '';
        if (vb == null) vb = '';
        if (typeof va === 'number' && typeof vb === 'number') return dir * (va - vb);
        return dir * String(va).localeCompare(String(vb));
      });
    }

    function renderizar() {
      filteredCount.textContent = dadosFiltrados.length;
      totalDisplay.textContent = dados.length;
      if (btnIndicadores) btnIndicadores.disabled = dadosFiltrados.length === 0;

      headerRow.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === sortCol) th.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      });

      if (!dadosFiltrados.length) {
        tbody.innerHTML = '<tr><td colspan="' + Math.max(colCount(), 1) + '" class="loading">Nenhum ativo encontrado com os filtros aplicados.</td></tr>';
        return;
      }

      const visibleCols = getVisibleColumnOrder();
      if (visibleCols.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + columnOrder.length + '" class="loading">Nenhuma coluna selecionada. Marque "Todos" ou escolha colunas no menu Colunas.</td></tr>';
        return;
      }

      tbody.innerHTML = dadosFiltrados.map(d => {
        const cells = visibleCols.map(key => {
          const col = COLUMNS[key];
          if (!col) return '';
          const cls = col.cls ? ' class="' + col.cls + '"' : '';
          const title = col.tdTitle ? ' title="' + (col.tdTitle(d) || '').replace(/"/g, '&quot;') + '"' : '';
          return '<td' + cls + title + '>' + col.cell(d) + '</td>';
        }).join('');
        return '<tr data-ticker="' + (d.stock || '').replace(/"/g, '&quot;') + '">' + cells + '</tr>';
      }).join('');

      tbody.querySelectorAll('tr[data-ticker]').forEach(tr => {
        tr.addEventListener('click', () => abrirDetalhes(tr.dataset.ticker));
      });
    }

    buildTableHeader();
    buildColunasDropdown();

    const btnIndicadores = document.getElementById('btnIndicadores');
    const btnColunas = document.getElementById('btnColunas');
    const colunasDropdown = document.getElementById('colunasDropdown');

    if (btnColunas && colunasDropdown) {
      btnColunas.addEventListener('click', (e) => {
        e.stopPropagation();
        colunasDropdown.classList.toggle('ativo');
      });
      document.addEventListener('click', () => colunasDropdown.classList.remove('ativo'));
      colunasDropdown.addEventListener('click', (e) => e.stopPropagation());
    }

    const indicadoresStatus = document.getElementById('indicadoresStatus');

    async function fetchComCors(url) {
      const tryFetch = async (u) => {
        const res = await fetch(u);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res;
      };
      try {
        return await tryFetch(url);
      } catch (e) {
        const proxies = ['https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?'];
        for (const pre of proxies) {
          try {
            return await tryFetch(pre + encodeURIComponent(url));
          } catch (_) { continue; }
        }
        throw e;
      }
    }

    function mergeIndicadores(r, d) {
      if (!d) return;
      d.priceEarnings = r.priceEarnings;
      d.earningsPerShare = r.earningsPerShare;
      let div12m = 0;
      if (r.dividendsData?.cashDividends?.length && r.regularMarketPrice) {
        const umAnoAtras = Date.now() - 365 * 24 * 60 * 60 * 1000;
        div12m = r.dividendsData.cashDividends
          .filter(x => new Date(x.paymentDate).getTime() > umAnoAtras)
          .reduce((s, x) => s + (Number(x.rate) || 0), 0);
        d.dividendYield = div12m > 0 ? (div12m / r.regularMarketPrice) * 100 : null;
      } else {
        d.dividendYield = null;
      }
      d.payout = (r.earningsPerShare > 0 && div12m > 0)
        ? (div12m / r.earningsPerShare) * 100 : null;
      if (r.priceToBook != null) d.priceToBook = r.priceToBook;
      if (r.returnOnEquity != null) d.returnOnEquity = r.returnOnEquity;
    }

    async function carregarIndicadores() {
      if (dadosFiltrados.length === 0) return;
      btnIndicadores.disabled = true;
      btnIndicadores.textContent = 'Carregando...';
      if (indicadoresStatus) indicadoresStatus.textContent = 'Buscando P/L, LPA e Div.Yield...';
      const tickers = dadosFiltrados.slice(0, 20).map(d => (d.stock || d.symbol || '')).filter(Boolean);
      let totalOk = 0;
      const BATCH = 3;
      for (let i = 0; i < tickers.length; i += BATCH) {
        const batch = tickers.slice(i, i + BATCH);
        const url = `${BRAPI_QUOTE}${batch.map(t => encodeURIComponent(t)).join(',')}?token=${getToken()}&fundamental=true&dividends=true`;
        try {
          const res = await fetchComCors(url);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          const results = json.results || [];
          results.forEach(r => {
            const symb = (r.symbol || '').trim();
            const d = dados.find(x => (x.stock || x.symbol || '').trim() === symb);
            if (d) {
              mergeIndicadores(r, d);
              totalOk++;
            }
          });
        } catch (e) {
          if (batch.length === 1) {
            if (indicadoresStatus) indicadoresStatus.textContent = 'Erro em ' + batch[0] + '. Tente com token pr√≥prio.';
          } else {
            for (const t of batch) {
              try {
                const rUrl = `${BRAPI_QUOTE}${encodeURIComponent(t)}?token=${getToken()}&fundamental=true&dividends=true`;
                const rRes = await fetchComCors(rUrl);
                if (!rRes.ok) continue;
                const rJson = await rRes.json();
                const r = rJson.results?.[0];
                if (r) {
                  const d = dados.find(x => (x.stock || x.symbol || '').trim() === (r.symbol || '').trim());
                  if (d) { mergeIndicadores(r, d); totalOk++; }
                }
              } catch (_) {}
            }
          }
        }
        if (i + BATCH < tickers.length) await new Promise(r => setTimeout(r, 400));
      }
      aplicarFiltros();
      btnIndicadores.disabled = false;
      btnIndicadores.textContent = 'Carregar indicadores (P/L, LPA, Div.Yield)';
      if (indicadoresStatus) {
        indicadoresStatus.textContent = totalOk > 0 ? '‚úì ' + totalOk + ' ativos com indicadores' : '‚ö† Nenhum obtido. Cole um token gratuito de brapi.dev no campo acima.';
        setTimeout(() => { if (indicadoresStatus) indicadoresStatus.textContent = ''; }, 10000);
      }
    }

    filtroBusca.addEventListener('input', aplicarFiltros);
    filtroSetor.addEventListener('change', aplicarFiltros);
    filtroTipo.addEventListener('change', aplicarFiltros);
    filtroPL?.addEventListener('input', aplicarFiltros);
    filtroPL?.addEventListener('change', aplicarFiltros);
    filtroDivYield?.addEventListener('input', aplicarFiltros);
    filtroDivYield?.addEventListener('change', aplicarFiltros);
    filtroPVP?.addEventListener('input', aplicarFiltros);
    filtroPVP?.addEventListener('change', aplicarFiltros);
    filtroROE?.addEventListener('input', aplicarFiltros);
    filtroROE?.addEventListener('change', aplicarFiltros);
    filtroPayout?.addEventListener('input', aplicarFiltros);
    filtroPayout?.addEventListener('change', aplicarFiltros);
    btnAtualizar.addEventListener('click', carregarDados);
    btnIndicadores.addEventListener('click', carregarIndicadores);

    async function abrirDetalhes(ticker) {
      if (!ticker) return;
      modalOverlay.classList.add('ativo');
      modalTicker.textContent = ticker;
      modalNome.textContent = dados.find(d => d.stock === ticker)?.name || '‚Äî';
      modalLogo.src = dados.find(d => d.stock === ticker)?.logo || 'https://icons.brapi.dev/icons/BRAPI.svg';
      modalLogo.onerror = () => { modalLogo.src = 'https://icons.brapi.dev/icons/BRAPI.svg'; };
      modalBody.innerHTML = '<div class="modal-loading">Carregando detalhes...</div>';

      try {
        const url = `${BRAPI_QUOTE}${encodeURIComponent(ticker)}?token=${getToken()}&fundamental=true&dividends=true`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Falha ao buscar detalhes');

        const json = await res.json();
        const r = json.results?.[0];
        if (!r) throw new Error('Sem dados');

        const preco = r.regularMarketPrice || 0;
        let div12m = 0;
        if (r.dividendsData?.cashDividends?.length) {
          const umAnoAtras = Date.now() - 365 * 24 * 60 * 60 * 1000;
          div12m = r.dividendsData.cashDividends
            .filter(x => new Date(x.paymentDate).getTime() > umAnoAtras)
            .reduce((s, x) => s + (Number(x.rate) || 0), 0);
        }
        const divYield = preco > 0 && div12m > 0 ? ((div12m / preco) * 100).toFixed(2) + '%' : '‚Äî';
        const pl = r.priceEarnings != null ? r.priceEarnings.toFixed(2) : '‚Äî';
        const lpa = r.earningsPerShare != null ? 'R$ ' + r.earningsPerShare.toFixed(2) : '‚Äî';
        const pvp = (r.priceToBook ?? r.priceToBookValue) != null ? Number(r.priceToBook ?? r.priceToBookValue).toFixed(2) : '‚Äî';
        const roeVal = r.returnOnEquity ?? r.roe;
        const roe = roeVal != null ? (Math.abs(roeVal) <= 1 ? Number(roeVal) * 100 : Number(roeVal)).toFixed(2) + '%' : '‚Äî';
        const payout = r.earningsPerShare > 0 && div12m > 0 ? ((div12m / r.earningsPerShare) * 100).toFixed(1) + '%' : '‚Äî';
        const min52 = r.fiftyTwoWeekLow; const max52 = r.fiftyTwoWeekHigh;
        const pos52 = (min52 != null && max52 != null && max52 > min52 && preco > 0)
          ? (((preco - min52) / (max52 - min52)) * 100).toFixed(1) + '%' : '‚Äî';
        const potAlta = (max52 != null && preco > 0 && max52 > preco)
          ? (((max52 - preco) / preco) * 100).toFixed(1) + '%' : '‚Äî';
        const potBaixa = (min52 != null && preco > 0 && min52 < preco)
          ? (((preco - min52) / preco) * 100).toFixed(1) + '%' : '‚Äî';
        const proxDiv = r.dividendsData?.cashDividends?.find(x => new Date(x.paymentDate) > new Date());
        const proxDivStr = proxDiv ? 'R$ ' + Number(proxDiv.rate).toFixed(4) + ' em ' + new Date(proxDiv.paymentDate).toLocaleDateString('pt-BR') : '‚Äî';

        const v = (val, fmt) => val != null && val !== '' ? (fmt ? fmt(val) : val) : '‚Äî';

        const indicatorsHtml = `
          <div class="modal-grid">
            <div class="modal-item"><label>Pre√ßo atual</label><span>${fmtPreco(preco)}</span></div>
            <div class="modal-item"><label>Varia√ß√£o %</label><span class="${classeVariacao(r.regularMarketChangePercent)}">${fmtPct(r.regularMarketChangePercent)}</span></div>
            <div class="modal-item"><label>P/L</label><span>${pl}</span></div>
            <div class="modal-item"><label>P/VP</label><span>${pvp}</span></div>
            <div class="modal-item"><label>ROE</label><span>${roe}</span></div>
            <div class="modal-item"><label>LPA</label><span>${lpa}</span></div>
            <div class="modal-item"><label>Div. Yield</label><span>${divYield}</span></div>
            <div class="modal-item"><label>Payout</label><span>${payout}</span></div>
            <div class="modal-item"><label>Dividendos 12m</label><span>${div12m > 0 ? 'R$ ' + div12m.toFixed(2) : '‚Äî'}</span></div>
            <div class="modal-item"><label>Pr√≥x. dividendo</label><span>${proxDivStr}</span></div>
            <div class="modal-item"><label>Posi√ß√£o 52 sem</label><span>${pos52}</span></div>
            <div class="modal-item"><label>Pot. alta 52 sem</label><span>${potAlta}</span></div>
            <div class="modal-item"><label>Pot. baixa 52 sem</label><span>${potBaixa}</span></div>
            <div class="modal-item"><label>Pre√ßo abertura</label><span>${fmtPreco(r.regularMarketOpen)}</span></div>
            <div class="modal-item"><label>M√°x./M√≠n. dia</label><span>${fmtPreco(r.regularMarketDayHigh)} / ${fmtPreco(r.regularMarketDayLow)}</span></div>
            <div class="modal-item"><label>Faixa 52 semanas</label><span>${r.fiftyTwoWeekRange || '‚Äî'}</span></div>
            <div class="modal-item"><label>Volume</label><span>${fmtNum(r.regularMarketVolume)}</span></div>
            <div class="modal-item"><label>Valor de mercado</label><span>${fmtMoeda(r.marketCap)}</span></div>
            <div class="modal-item"><label>Beta</label><span>${v(r.beta)}</span></div>
            <div class="modal-item"><label>Moeda</label><span>${r.currency || 'BRL'}</span></div>
            <div class="modal-item"><label>Atualiza√ß√£o</label><span>${r.regularMarketTime ? new Date(r.regularMarketTime).toLocaleString('pt-BR') : '‚Äî'}</span></div>
          </div>
          <div class="modal-chart-section">
            <label style="display:block;margin-bottom:0.5rem;font-size:0.8rem;color:var(--text-muted);">Gr√°fico de cota√ß√£o</label>
            <div class="modal-chart-filters">
              <button type="button" data-range="1d" data-interval="5m">Hoje</button>
              <button type="button" data-range="5d" data-interval="15m">Semana</button>
              <button type="button" data-range="1mo" data-interval="1d">M√™s</button>
              <button type="button" data-range="1y" data-interval="1d">Ano</button>
              <button type="button" data-range="ytd" data-interval="1d">Anualizado</button>
              <button type="button" data-range="5y" data-interval="1d">5 anos</button>
              <button type="button" data-range="max" data-interval="1d" class="ativo">Tudo</button>
            </div>
            <div class="modal-chart-wrap"><canvas id="modalChart"></canvas></div>
          </div>
        `;
        modalBody.innerHTML = indicatorsHtml;
        loadChartData(ticker, 'max', '1d');
        modalBody.querySelectorAll('.modal-chart-filters button').forEach(btn => {
          btn.addEventListener('click', () => loadChartData(ticker, btn.dataset.range, btn.dataset.interval));
        });
      } catch (e) {
        modalBody.innerHTML = '<div class="modal-loading">Erro ao carregar detalhes. Tente novamente.</div>';
      }
    }

    let modalChartInstance = null;

    async function loadChartData(ticker, range, interval) {
      const wrap = document.querySelector('.modal-chart-wrap');
      const canvas = document.getElementById('modalChart');
      if (!canvas || !ticker) return;
      const ctx = canvas.getContext('2d');
      if (modalChartInstance) { modalChartInstance.destroy(); modalChartInstance = null; }
      const filters = wrap?.parentElement?.querySelector('.modal-chart-filters');
      filters?.querySelectorAll('button').forEach(b => b.classList.remove('ativo'));
      const btn = filters?.querySelector(`button[data-range="${range}"]`);
      if (btn) btn.classList.add('ativo');
      const prevErr = wrap?.querySelector('.chart-error');
      if (prevErr) prevErr.remove();
      canvas.style.display = '';

      const url = `${BRAPI_QUOTE}${encodeURIComponent(ticker)}?token=${getToken()}&range=${range}&interval=${interval}`;
      try {
        const res = await fetchComCors(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        let points = [];
        const h = json.results?.[0]?.historicalDataPrice || json.historical || json.prices || (Array.isArray(json) ? json : []);
        if (h && h.length) {
          points = h.map(x => {
            const dt = x.date || x.timestamp || x.t;
            const ts = typeof dt === 'number' ? dt * (dt < 1e10 ? 1000 : 1) : new Date(dt).getTime();
            const close = x.close ?? x.adjustedClose ?? x.adjClose ?? x.c;
            return { x: ts, y: close != null ? Number(close) : null };
          }).filter(p => p.y != null);
        }
        if (points.length === 0) throw new Error('Sem dados de hist√≥rico');
        points.sort((a, b) => a.x - b.x);
        const labels = points.map(p => new Date(p.x).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: range === '1d' || range === '5d' ? undefined : '2-digit' }));
        const cor = points[points.length - 1]?.y >= (points[0]?.y || 0) ? 'rgba(0, 200, 83, 0.8)' : 'rgba(255, 82, 82, 0.8)';
        modalChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{ label: 'Pre√ßo (R$)', data: points.map(p => p.y), borderColor: cor, backgroundColor: cor + '22', fill: true, tension: 0.2 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#8b9199', maxTicksLimit: 8 } },
              y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#8b9199', callback: v => 'R$ ' + Number(v).toFixed(2) } }
            }
          }
        });
      } catch (err) {
        canvas.style.display = 'none';
        const noData = document.createElement('div');
        noData.className = 'modal-loading chart-error';
        noData.style.padding = '2rem';
        noData.textContent = 'Gr√°fico indispon√≠vel. Use token brapi.dev (hist√≥rico exige plano pago em alguns casos).';
        wrap?.appendChild(noData);
      }
    }

    modalFechar.addEventListener('click', () => modalOverlay.classList.remove('ativo'));
    modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) modalOverlay.classList.remove('ativo'); });

    const brapiTokenEl = document.getElementById('brapiToken');
    if (brapiTokenEl) {
      const saved = localStorage.getItem(TOKEN_KEY);
      if (saved) brapiTokenEl.value = saved;
      brapiTokenEl.addEventListener('change', () => {
        const v = brapiTokenEl.value.trim();
        if (v) localStorage.setItem(TOKEN_KEY, v);
        else localStorage.removeItem(TOKEN_KEY);
      });
    }

    carregarDados();
    setInterval(carregarDados, 30000);
  </script>
</body>
</html>
